name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-pr:
    name: Validate PR title
    runs-on: ubuntu-latest

    steps:
      - name: Check semantic PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            test
            chore
          requireScope: false

  coverage-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - run: chmod +x gradlew

      # Build + Test + Coverage (una sola volta)
      - name: Run tests & coverage
        run: ./gradlew test jacocoRootReport

      # Read baseline
      - name: Read baseline
        id: base
        run: |
          echo "total=$(jq -r '.total' coverage-baseline.json)" >> $GITHUB_OUTPUT
          echo "line=$(jq -r '.line' coverage-baseline.json)" >> $GITHUB_OUTPUT
          echo "branch=$(jq -r '.branch' coverage-baseline.json)" >> $GITHUB_OUTPUT
          echo "function=$(jq -r '.function' coverage-baseline.json)" >> $GITHUB_OUTPUT

      # Extract PR coverage
      - name: Extract PR coverage
        id: pr
        run: |
          XML=build/reports/jacoco/jacocoRootReport/jacocoRootReport.xml

          read () {
            TYPE=$1
            C=$(xmllint --xpath "string(//counter[@type='$TYPE']/@covered)" $XML)
            M=$(xmllint --xpath "string(//counter[@type='$TYPE']/@missed)" $XML)
            awk "BEGIN { printf \"%.2f\", ($C/($C+$M))*100 }"
          }

          LINE=$(read LINE)
          BRANCH=$(read BRANCH)
          FUNCTION=$(read METHOD)

          echo "total=$LINE" >> $GITHUB_OUTPUT
          echo "line=$LINE" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "function=$FUNCTION" >> $GITHUB_OUTPUT

      # Fail policy: SOLO TOTAL
      - name: Fail if Total decreased
        run: |
          BASE=${{ steps.base.outputs.total }}
          PR=${{ steps.pr.outputs.total }}
          DELTA=$(awk "BEGIN { printf \"%.2f\", ($PR - $BASE) }")

          echo "Total â†’ Base: $BASE%, PR: $PR%, Î” $DELTA%"
          if (( $(echo "$DELTA < 0" | bc -l) )); then
            exit 1
          fi

      # Comment PR
      - name: Comment PR with coverage
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const cur = {
              total: parseFloat("${{ steps.pr.outputs.total }}"),
              line: parseFloat("${{ steps.pr.outputs.line }}"),
              branch: parseFloat("${{ steps.pr.outputs.branch }}"),
              func: parseFloat("${{ steps.pr.outputs.function }}")
            }

            const base = {
              total: parseFloat("${{ steps.base.outputs.total }}"),
              line: parseFloat("${{ steps.base.outputs.line }}"),
              branch: parseFloat("${{ steps.base.outputs.branch }}"),
              func: parseFloat("${{ steps.base.outputs.function }}")
            }

            const fmt = n => n.toFixed(2)
            const trend = d => d >= 0 ? "ðŸŸ¢" : "ðŸ”´"
            const sign = d => d >= 0 ? "+" : ""

            const row = (k, l) => {
              const d = cur[k] - base[k]
              return `**${l}:** ${fmt(cur[k])}% ${trend(d)} ${sign(d)}${fmt(d)}`
            }

            const body = `
            ðŸ“Š **Code Coverage Report**
            
            ${row("total","Total")}
            ${row("line","Lines")}
            ${row("branch","Branches")}
            ${row("func","Functions")}
            `
  
            const { data } = await github.rest.issues.listComments({
              ...context.repo,
              issue_number: context.issue.number
            })
            
            const prev = data.find(c => c.body.includes("Code Coverage Report"))
            
            if (prev) {
              await github.rest.issues.updateComment({
                ...context.repo,
                comment_id: prev.id,
                body
              })
            } else {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body
              })
            }